<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>æ³¨å†Œ</title>
    <link rel="stylesheet" href="../assets/libs/particles/css/style.css">
    <link rel="stylesheet" href="../assets/libs/sweetalert2/sweetalert2.min.css">
    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/login.css">
    <script src="util/md5Util.js"></script>
</head>
<body>
<!-- particles.js container -->
<div id="particles-js"></div>
<div id="wrapper">
    <div>
        <img src="../assets/img/zhihu_logo.png"/>
        <h2>åƒå¹´çš„æ‰¿è¯ºåŒ–ä¸ºé£çµ®ï¼Œæµªæ¼«çº¢å°˜ç•™ä½ä½ æˆ‘</h2>
    </div>
    <nav class="switch_nav">
        <a href="javascript:;" id="switch_signup" class="switch_btn on">æ³¨å†Œ</a>
        <a href="login.html" id="switch_login" class="switch_btn">ç™»é™†</a>
        <div class="switch_bottom" id="switch_bottom"></div>
    </nav>
    <form method="post" action="">
        <ul class="group_input">
            <li>
                <input type="text" placeholder="ç”¨æˆ·å" class="name required" id="name"/>
            </li>
            <li>
                <input type="text" placeholder="æ‰‹æœºå·(ä»…æ”¯æŒä¸­å›½å¤§é™†)æˆ–é‚®ç®±" class="mobile required" id="mobile"/>
            </li>

            <li>
                <input type="text" style="width: 150px" placeholder="éªŒè¯ç " class="verification" id="verification">
                <button type="button" style="width: 120px;height: 40px;background: #ffffff;border-radius: 3px;
                border: 1px solid #0f88eb;color: #2492ec;" id="sendVerification">å‘é€éªŒè¯ç 
                </button>
            </li>

            <li>
                <input type="password" placeholder="å¯†ç (ä¸å°‘äº6ä½)" class="psd required" id="psd"/>
            </li>

        </ul>
        <button type="button" class="submit_btn" id="btnSubmit">æ³¨å†Œå¤©ç¼˜</button>
        <span class="agreement-tip">ç‚¹å‡»ã€Œæ³¨å†Œã€æŒ‰é’®ï¼Œå³ä»£è¡¨ä½ åŒæ„<a href="javascript:;">ã€Šå¤©ç¼˜åè®®ã€‹</a></span>
    </form>
    <div class="QRcode_btn">
        <div type="submit" class="submit_btn download_btn">ä¸‹è½½å¤©ç¼˜App</div>
        <div class="QRcode">
            <img src="../assets/img/QRcode.png" alt="QRcode"/>
            <div class="box"></div>
        </div>

    </div>


    <div id="footer">
        <span>&copy;2017å¤©ç¼˜</span><span>Â·</span><a href="javascript:;"å¤©ç¼˜</a><span>Â·</span><a
            href="javascript:;">å‘ç°</a><span>Â·</span><a href="javascript:;">ç§»åŠ¨åº”ç”¨</a><span>Â·</span><a href="javascript:;">ä½¿ç”¨æœºæ„è´¦å·ç™»å½•</a><span>Â·</span><a
            href="javascript:;">è”ç³»æˆ‘ä»¬</a><span>Â·</span><a href="javascript:;">é‡è§çˆ±æƒ…æ¥å¤©ç¼˜</a><br/>
        <span>Â·</span><a
            href="javascript:;">äº¬ICPè¯110745å·</a><span>Â·</span><span>äº¬å…¬ç½‘å®‰å¤‡11010802010035å·</span><span>Â·</span><a
            href="javascript:;">å‡ºç‰ˆç‰©ç»è¥è®¸å¯è¯</a>
    </div>
</div>
<script src="../assets/libs/jquery-1.12.4/jquery.min.js"></script>
<script src="../assets/libs/sweetalert2/sweetalert2.min.js"></script>
<script src="../assets/libs/particles/particles.min.js"></script>
<script src="../assets/libs/particles/js/app.js"></script>
<!-- <script src="../assets/libs/particles/js/lib/stats.js"></script> -->
<script>
    // var count_particles, stats, update;
    // stats = new Stats;
    // stats.setMode(0);
    // stats.domElement.style.position = 'absolute';
    // stats.domElement.style.left = '0px';
    // stats.domElement.style.top = '0px';
    // document.body.appendChild(stats.domElement);
    // count_particles = document.querySelector('.js-count-particles');
    // update = function() {
    // 	stats.begin();
    // 	stats.end();
    // 	if (window.pJSDom[0].pJS.particles && window.pJSDom[0].pJS.particles.array) {
    // 		count_particles.innerText = window.pJSDom[0].pJS.particles.array.length;
    // 	}
    // 	requestAnimationFrame(update);
    // };
    // requestAnimationFrame(update);
</script>
<script>
    $(".download_btn").click(function () {
        if ($(".QRcode").css("display") == "none") {
            $(".QRcode").show();
            $(".download_btn").text("å…³é—­äºŒç»´ç ");
        } else {
            $(".QRcode").hide();
            $(".download_btn").text("ä¸‹è½½å¤©ç¼˜App");
        }
    });
</script>
<script>
    const check = {
        nameLocalCheck: false,
        nameNetCheck: false,
        password: false,
        emailOrPhone: false,
        emailOrPhoneNetCheck: false,
        verificationCode: false
    };
    $("form :input").keyup(function () {
        let $parent = $(this).parent();
        $parent.find(".msg").remove();
        //éªŒè¯å§“å
        if ($(this).is("#name")) {
            checkUsername($parent, this);
        }
        //éªŒè¯é‚®ç®±
        if ($(this).is("#mobile")) {
            checkEmail($parent, this);
        }
        //éªŒè¯å¯†ç 
        if ($(this).is("#psd")) {
            checkPassword($parent, this);
        }

    }).focus(function () {
        $(this).triggerHandler("keyup");
    });

    /**
     *  æ ¡éªŒç”¨æˆ·å
     */
    function checkUsername($parent, obj) {
        let nameVal = $.trim(obj.value);
        let regName = /[~#^$@%&!*()<>:;'"{}ã€ã€‘  ]/;
        if (nameVal == "" || nameVal.length < 2 || regName.test(nameVal)) {
            let errorMsg = " å§“åéç©ºï¼Œé•¿åº¦2-20ä½ï¼Œä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼";
            check.nameLocalCheck = false;
            $parent.append("<span class='msg onError'>" + errorMsg + "</span>");
        } else {
            let okMsg = " è¾“å…¥æ­£ç¡®";
            check.nameLocalCheck = true;
            $parent.append("<span id='success' class='msg onSuccess'>" + okMsg + "</span>");
        }
    }

    /**
     *æ ¡éªŒé‚®ç®±
     */
    function checkEmail($parent, obj) {
        let mobileVal = $.trim(obj.value);
        let regMobile = /^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/;
        if (mobileVal == "" || !regMobile.test(mobileVal)) {
            let errorMsg = " è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±ï¼";
            check.emailOrPhone = false;
            $parent.append("<span id='ems' class='msg onError'>" + errorMsg + "</span>");
        } else {
            let okMsg = " è¾“å…¥æ­£ç¡®";
            check.emailOrPhone = true;
            $parent.append("<span id='ems' class='msg onSuccess'>" + okMsg + "</span>");
        }
    }

    /**
     * æ ¡éªŒå¯†ç 
     */
    function checkPassword($parent, obj) {
        let psdVal = $.trim(obj.value);
        let regPsd = /^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,20}$/;
        if (psdVal == "" || !regPsd.test(psdVal)) {
            let errorMsg = " å¯†ç ä¸º6-20ä½å­—æ¯ã€æ•°å­—çš„ç»„åˆï¼";
            check.password = false;
            $parent.append("<span class='msg onError'>" + errorMsg + "</span>");
        } else {
            let okMsg = " è¾“å…¥æ­£ç¡®";
            check.password = true;
            $parent.append("<span id='psdSuccess' class='msg onSuccess'>" + okMsg + "</span>");
        }
    }


    $("#name").blur(function () {
        /**
         * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²ç»æ³¨å†Œ
         */
        if (check.nameLocalCheck) {
            $.ajax({
                url: "/user/checkName/" + $("#name").val(),
                type: "GET",
                success: function (data) {
                    if (!data.data) {
                        let errorMsg = "ç”¨æˆ·åå·²å­˜åœ¨,æ¢ä¸€ä¸ªè¯•è¯•å§";
                        $("#success").attr('class', 'msg onError');
                        $("#success").html(errorMsg);
                        check.nameNetCheck = false;
                    } else {
                        check.nameNetCheck = true;
                    }
                }
            })
        }
    });


    /**
     * æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²ç»æ³¨å†Œ
     */
    $("#mobile").blur(function () {
        if (check.emailOrPhone) {
            $.ajax({
                url: "/user/checkEmail/" + $("#mobile").val(),
                type: "GET",
                success: function (data) {
                    console.log(data);
                    if (!data.data) {
                        let errorMsg = "è¯¥é‚®ç®±å·²æ³¨å†Œï¼";
                        $("#ems").attr('class', 'msg onError');
                        $("#ems").html(errorMsg);
                        check.emailOrPhoneNetCheck = false;
                    } else {
                        check.emailOrPhoneNetCheck = true;
                        // $("#sendVerification").attr("disabled", false);
                    }

                }
            })
        }
    })

    //ç‚¹å‡»é‡ç½®æŒ‰é’®æ—¶ï¼Œé€šè¿‡trigger()æ¥è§¦å‘æ–‡æœ¬æ¡†çš„å¤±å»ç„¦ç‚¹äº‹ä»¶
    $("#btnSubmit").click(function () {
        //trigger äº‹ä»¶æ‰§è¡Œå®Œåï¼Œæµè§ˆå™¨ä¼šä¸ºsubmitæŒ‰é’®è·å¾—ç„¦ç‚¹
        $("form .required:input").trigger("blur");
        let numError = $("form .onError").length;
        if (numError) {
            return false;
        }
        // alert('æ³¨å†ŒæˆåŠŸï¼')

    });

    $("#sendVerification").hover(function () {
        $("#sendVerification").css('background', "#0f88eb");
        $("#sendVerification").css('color', 'rgb(255,255,255)');
    }, function () {
        $("#sendVerification").css('background', '#ffffff');
        $("#sendVerification").css('color', '#2492ec');
    });


    /**
     * å‘é€éªŒè¯ç 
     */
    $("#sendVerification").click(function () {
        let email = $("#mobile").val();
        if (check.emailOrPhone && check.emailOrPhoneNetCheck) {
            $("#sendVerification").attr("disabled", true);
            let time = 90;
            let IntervalId = setInterval(function () {
                $("#sendVerification").text(time + "åå†è¯•");
                if (time == 0) {
                    $("#sendVerification").text("å‘é€éªŒè¯ç ");
                    clearInterval(IntervalId);
                    $("#sendVerification").attr("disabled", false);
                }
                time--;
            }, 1000);
            $.ajax({
                url: "/user/sendEmail/" + $("#mobile").val(),
                type: "GET",
                success: function (data) {
                    console.log(data);
                    let $parent = $("#sendVerification").parent();
                    $parent.children("span").remove();
                    if (data.data) {
                        let okMsg = "å‘é€æˆåŠŸï¼"
                        $parent.append("<span  class='msg onSuccess'>" + okMsg + "</span>");
                    } else {
                        let errorMsg = "å‘é€å¤±è´¥ï¼"
                        $parent.append("<span  class='msg onError'>" + errorMsg + "</span>");
                    }
                }
            });
        }
    });

    $("#btnSubmit").click(function () {
        let registerVo=getRegisterVo();
        if (!$.isEmptyObject(registerVo)) {
            $.ajax({
                url: "/user/register",
                type: "POST",
                contentType: "application/json;charset=UTF-8",
                data: JSON.stringify(registerVo) ,
                success: function (data) {
                    if (data.data) {
                        alert("æ³¨å†ŒæˆåŠŸï¼")
                        window.location.href = "/login.html";
                    } else {
                       alert("æ³¨å†Œå¤±è´¥ï¼")
                    }
                }
            });
        } else {
            alert("æˆ‘çŸ¥é“ä½ æ˜¯ä¸“ä¸šçš„ï¼Œè¯·ä¸è¦ä¿®æ”¹jsä»£ç ğŸ˜Š")
        }

    });

    function getRegisterVo() {
        if (check.nameLocalCheck && check.nameNetCheck &&
            check.emailOrPhone && check.emailOrPhoneNetCheck && check.password) {
            let registerVo = {
                username: $("#name").val(),
                email: $("#mobile").val(),
                verification: $("#verification").val(),
                password: md5($("#psd").val(), 32),
            };
            return registerVo;
        }
        return {};
    }


</script>
</body>
</html>
